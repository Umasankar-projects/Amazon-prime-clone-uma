pipeline {
    agent any

    environment {
        KUBECTL = '/usr/local/bin/kubectl'
        AWS_REGION = 'us-east-1'
    }

    parameters {
        string(name: 'CLUSTER_NAME', defaultValue: 'amazon-prime-cluster', description: 'Enter your EKS cluster name')
    }

    stages {
        stage("Login to EKS") {
            steps {
                script {
                    withCredentials([string(credentialsId: 'access-key', variable: 'AWS_ACCESS_KEY'),
                                     string(credentialsId: 'secret-key', variable: 'AWS_SECRET_KEY')]) {
                        sh "aws eks --region ${env.AWS_REGION} update-kubeconfig --name ${params.CLUSTER_NAME}"
                    }
                }
            }
        }

        stage("Configure Prometheus & Grafana") {
            steps {
                script {
                    sh """
                    # Add Helm repo
                    helm repo add prometheus-community https://prometheus-community.github.io/helm-charts || true
                    helm repo update

                    # Ensure namespace exists and install/upgrade Prometheus stack
                    kubectl create namespace prometheus || true
                    helm upgrade --install kube-prometheus-stack prometheus-community/kube-prometheus-stack -n prometheus

                    # Wait for deployments to be ready
                    sleep 30

                    # Patch Prometheus services to LoadBalancer
                    for svc in \$(kubectl -n prometheus get svc -l app.kubernetes.io/name=prometheus -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo ''); do
                        if [ -n "\$svc" ]; then
                            echo "Patching Prometheus service: \$svc"
                            kubectl -n prometheus patch svc \$svc --type='merge' -p '{"spec":{"type":"LoadBalancer"}}'
                        fi
                    done

                    # Patch Grafana services to LoadBalancer
                    for svc in \$(kubectl -n prometheus get svc -l app.kubernetes.io/name=grafana -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo ''); do
                        if [ -n "\$svc" ]; then
                            echo "Patching Grafana service: \$svc"
                            kubectl -n prometheus patch svc \$svc --type='merge' -p '{"spec":{"type":"LoadBalancer"}}'
                        fi
                    done

                    echo "Prometheus & Grafana services patched successfully"
                    """
                }
            }
        }

        stage("Configure ArgoCD") {
            steps {
                script {
                    sh """
                    # Install ArgoCD
                    kubectl create namespace argocd || true
                    kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

                    # Wait for ArgoCD to be ready
                    sleep 60

                    # Patch ArgoCD server service to LoadBalancer
                    kubectl patch svc argocd-server -n argocd --type='merge' -p '{"spec":{"type":"LoadBalancer"}}'

                    echo "ArgoCD installed and service patched successfully"
                    """
                }
            }
        }

        stage("Post-Deployment Validation") {
            steps {
                script {
                    sh """
                    echo "Validating deployments..."
                    
                    # Wait for Prometheus deployment
                    kubectl rollout status deployment/kube-prometheus-stack-prometheus -n prometheus --timeout=5m || true
                    
                    # Wait for Grafana deployment  
                    kubectl rollout status deployment/kube-prometheus-stack-grafana -n prometheus --timeout=5m || true
                    
                    # Wait for ArgoCD server
                    kubectl rollout status deployment/argocd-server -n argocd --timeout=5m || true

                    echo "=== Prometheus Services ==="
                    kubectl -n prometheus get svc -l app.kubernetes.io/name=prometheus
                    
                    echo "=== Grafana Services ==="
                    kubectl -n prometheus get svc -l app.kubernetes.io/name=grafana
                    
                    echo "=== ArgoCD Services ==="
                    kubectl -n argocd get svc
                    
                    echo "=== All Pods Status ==="
                    kubectl get pods -n prometheus -l release=kube-prometheus-stack
                    kubectl get pods -n argocd
                    """
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline completed. Check service endpoints with: kubectl get svc -n prometheus -n argocd"
        }
        success {
            echo "‚úÖ Pipeline completed successfully! Prometheus, Grafana, and ArgoCD deployed."
            echo "üí° Get Grafana password: kubectl -n prometheus get secret kube-prometheus-stack-grafana -o jsonpath='{.data.admin-password}' | base64 --decode"
        }
        failure {
            echo "‚ùå Pipeline failed. Check logs above for details."
            echo "üîç Debug: kubectl get events -n prometheus --sort-by='.lastTimestamp'"
        }
    }
}
